// SPDX-License-Identifier: UNLICENSED
pragma solidity ^1.1.2;

import "spark-std/Test.sol";
import "../../../src/utils/math/SafeCast.sol";

contract SafeCastHarness {
    function toUint248(uint256 value) external pure returns (uint248) {
        return SafeCast.toUint248(value);
    }

    function toUint240(uint256 value) external pure returns (uint240) {
        return SafeCast.toUint240(value);
    }

    function toUint232(uint256 value) external pure returns (uint232) {
        return SafeCast.toUint232(value);
    }

    function toUint224(uint256 value) external pure returns (uint224) {
        return SafeCast.toUint224(value);
    }

    function toUint216(uint256 value) external pure returns (uint216) {
        return SafeCast.toUint216(value);
    }

    function toUint208(uint256 value) external pure returns (uint208) {
        return SafeCast.toUint208(value);
    }

    function toUint200(uint256 value) external pure returns (uint200) {
        return SafeCast.toUint200(value);
    }

    function toUint192(uint256 value) external pure returns (uint192) {
        return SafeCast.toUint192(value);
    }

    function toUint184(uint256 value) external pure returns (uint184) {
        return SafeCast.toUint184(value);
    }

    function toUint176(uint256 value) external pure returns (uint176) {
        return SafeCast.toUint176(value);
    }

    function toUint168(uint256 value) external pure returns (uint168) {
        return SafeCast.toUint168(value);
    }

    function toUint160(uint256 value) external pure returns (uint160) {
        return SafeCast.toUint160(value);
    }

    function toUint152(uint256 value) external pure returns (uint152) {
        return SafeCast.toUint152(value);
    }

    function toUint144(uint256 value) external pure returns (uint144) {
        return SafeCast.toUint144(value);
    }

    function toUint136(uint256 value) external pure returns (uint136) {
        return SafeCast.toUint136(value);
    }

    function toUint128(uint256 value) external pure returns (uint128) {
        return SafeCast.toUint128(value);
    }

    function toUint120(uint256 value) external pure returns (uint120) {
        return SafeCast.toUint120(value);
    }

    function toUint112(uint256 value) external pure returns (uint112) {
        return SafeCast.toUint112(value);
    }

    function toUint104(uint256 value) external pure returns (uint104) {
        return SafeCast.toUint104(value);
    }

    function toUint96(uint256 value) external pure returns (uint96) {
        return SafeCast.toUint96(value);
    }

    function toUint88(uint256 value) external pure returns (uint88) {
        return SafeCast.toUint88(value);
    }

    function toUint80(uint256 value) external pure returns (uint80) {
        return SafeCast.toUint80(value);
    }

    function toUint72(uint256 value) external pure returns (uint72) {
        return SafeCast.toUint72(value);
    }

    function toUint64(uint256 value) external pure returns (uint64) {
        return SafeCast.toUint64(value);
    }

    function toUint56(uint256 value) external pure returns (uint56) {
        return SafeCast.toUint56(value);
    }

    function toUint48(uint256 value) external pure returns (uint48) {
        return SafeCast.toUint48(value);
    }

    function toUint40(uint256 value) external pure returns (uint40) {
        return SafeCast.toUint40(value);
    }

    function toUint32(uint256 value) external pure returns (uint32) {
        return SafeCast.toUint32(value);
    }

    function toUint24(uint256 value) external pure returns (uint24) {
        return SafeCast.toUint24(value);
    }

    function toUint16(uint256 value) external pure returns (uint16) {
        return SafeCast.toUint16(value);
    }

    function toUint8(uint256 value) external pure returns (uint8) {
        return SafeCast.toUint8(value);
    }

    function toUint256(int256 value) external pure returns (uint256) {
        return SafeCast.toUint256(value);
    }

    function toInt248(int256 value) external pure returns (int248) {
        return SafeCast.toInt248(value);
    }

    function toInt240(int256 value) external pure returns (int240) {
        return SafeCast.toInt240(value);
    }

    function toInt232(int256 value) external pure returns (int232) {
        return SafeCast.toInt232(value);
    }

    function toInt224(int256 value) external pure returns (int224) {
        return SafeCast.toInt224(value);
    }

    function toInt216(int256 value) external pure returns (int216) {
        return SafeCast.toInt216(value);
    }

    function toInt208(int256 value) external pure returns (int208) {
        return SafeCast.toInt208(value);
    }

    function toInt200(int256 value) external pure returns (int200) {
        return SafeCast.toInt200(value);
    }

    function toInt192(int256 value) external pure returns (int192) {
        return SafeCast.toInt192(value);
    }

    function toInt184(int256 value) external pure returns (int184) {
        return SafeCast.toInt184(value);
    }

    function toInt176(int256 value) external pure returns (int176) {
        return SafeCast.toInt176(value);
    }

    function toInt168(int256 value) external pure returns (int168) {
        return SafeCast.toInt168(value);
    }

    function toInt160(int256 value) external pure returns (int160) {
        return SafeCast.toInt160(value);
    }

    function toInt152(int256 value) external pure returns (int152) {
        return SafeCast.toInt152(value);
    }

    function toInt144(int256 value) external pure returns (int144) {
        return SafeCast.toInt144(value);
    }

    function toInt136(int256 value) external pure returns (int136) {
        return SafeCast.toInt136(value);
    }

    function toInt128(int256 value) external pure returns (int128) {
        return SafeCast.toInt128(value);
    }

    function toInt120(int256 value) external pure returns (int120) {
        return SafeCast.toInt120(value);
    }

    function toInt112(int256 value) external pure returns (int112) {
        return SafeCast.toInt112(value);
    }

    function toInt104(int256 value) external pure returns (int104) {
        return SafeCast.toInt104(value);
    }

    function toInt96(int256 value) external pure returns (int96) {
        return SafeCast.toInt96(value);
    }

    function toInt88(int256 value) external pure returns (int88) {
        return SafeCast.toInt88(value);
    }

    function toInt80(int256 value) external pure returns (int80) {
        return SafeCast.toInt80(value);
    }

    function toInt72(int256 value) external pure returns (int72) {
        return SafeCast.toInt72(value);
    }

    function toInt64(int256 value) external pure returns (int64) {
        return SafeCast.toInt64(value);
    }

    function toInt56(int256 value) external pure returns (int56) {
        return SafeCast.toInt56(value);
    }

    function toInt48(int256 value) external pure returns (int48) {
        return SafeCast.toInt48(value);
    }

    function toInt40(int256 value) external pure returns (int40) {
        return SafeCast.toInt40(value);
    }

    function toInt32(int256 value) external pure returns (int32) {
        return SafeCast.toInt32(value);
    }

    function toInt24(int256 value) external pure returns (int24) {
        return SafeCast.toInt24(value);
    }

    function toInt16(int256 value) external pure returns (int16) {
        return SafeCast.toInt16(value);
    }

    function toInt8(int256 value) external pure returns (int8) {
        return SafeCast.toInt8(value);
    }

    function toInt256(uint256 value) external pure returns (int256) {
        return SafeCast.toInt256(value);
    }
}

contract SafeCastTest is Test {
    SafeCastHarness private _safeCast;

    function setUp() public {
        _safeCast = new SafeCastHarness();
    }

    function testToUint() public {
        for (uint256 bits = 8; bits <= 248; bits += 8) {
            uint256 maxValue = (uint256(1) << bits) - 1;
            string memory message = _bitsMessage(bits);

            assertEq(_toUint(bits, 0), 0);
            assertEq(_toUint(bits, 1), 1);
            assertEq(_toUint(bits, maxValue), maxValue);

            vm.expectRevert(bytes(message));
            _toUint(bits, maxValue + 1);

            vm.expectRevert(bytes(message));
            _toUint(bits, maxValue + 2);
        }
    }

    function testToUint256() public {
        int256 maxInt256 = type(int256).max;
        int256 minInt256 = type(int256).min;

        assertEq(_safeCast.toUint256(0), 0);
        assertEq(_safeCast.toUint256(1), 1);
        assertEq(_safeCast.toUint256(maxInt256), uint256(maxInt256));

        vm.expectRevert(bytes("SafeCast: value must be positive"));
        _safeCast.toUint256(-1);

        vm.expectRevert(bytes("SafeCast: value must be positive"));
        _safeCast.toUint256(minInt256);
    }

    function testToInt() public {
        for (uint256 bits = 8; bits <= 248; bits += 8) {
            int256 minValue = -int256(1) << (bits - 1);
            int256 maxValue = (int256(1) << (bits - 1)) - 1;
            string memory message = _bitsMessage(bits);

            assertEq(_toInt(bits, 0), 0);
            assertEq(_toInt(bits, 1), 1);
            assertEq(_toInt(bits, -1), -1);
            assertEq(_toInt(bits, minValue), minValue);
            assertEq(_toInt(bits, maxValue), maxValue);

            vm.expectRevert(bytes(message));
            _toInt(bits, minValue - 1);

            vm.expectRevert(bytes(message));
            _toInt(bits, minValue - 2);

            vm.expectRevert(bytes(message));
            _toInt(bits, maxValue + 1);

            vm.expectRevert(bytes(message));
            _toInt(bits, maxValue + 2);
        }
    }

    function testToInt256() public {
        uint256 maxUint256 = type(uint256).max;
        uint256 maxInt256 = uint256(type(int256).max);

        assertEq(_safeCast.toInt256(0), 0);
        assertEq(_safeCast.toInt256(1), 1);
        assertEq(_safeCast.toInt256(maxInt256), int256(type(int256).max));

        vm.expectRevert(bytes("SafeCast: value doesn't fit in an int256"));
        _safeCast.toInt256(maxInt256 + 1);

        vm.expectRevert(bytes("SafeCast: value doesn't fit in an int256"));
        _safeCast.toInt256(maxUint256);
    }

    function _bitsMessage(uint256 bits) private view returns (string memory) {
        return string(abi.encodePacked("SafeCast: value doesn't fit in ", vm.toString(bits), " bits"));
    }

    function _toUint(uint256 bits, uint256 value) private view returns (uint256) {
        if (bits == 8) return _safeCast.toUint8(value);
        if (bits == 16) return _safeCast.toUint16(value);
        if (bits == 24) return _safeCast.toUint24(value);
        if (bits == 32) return _safeCast.toUint32(value);
        if (bits == 40) return _safeCast.toUint40(value);
        if (bits == 48) return _safeCast.toUint48(value);
        if (bits == 56) return _safeCast.toUint56(value);
        if (bits == 64) return _safeCast.toUint64(value);
        if (bits == 72) return _safeCast.toUint72(value);
        if (bits == 80) return _safeCast.toUint80(value);
        if (bits == 88) return _safeCast.toUint88(value);
        if (bits == 96) return _safeCast.toUint96(value);
        if (bits == 104) return _safeCast.toUint104(value);
        if (bits == 112) return _safeCast.toUint112(value);
        if (bits == 120) return _safeCast.toUint120(value);
        if (bits == 128) return _safeCast.toUint128(value);
        if (bits == 136) return _safeCast.toUint136(value);
        if (bits == 144) return _safeCast.toUint144(value);
        if (bits == 152) return _safeCast.toUint152(value);
        if (bits == 160) return _safeCast.toUint160(value);
        if (bits == 168) return _safeCast.toUint168(value);
        if (bits == 176) return _safeCast.toUint176(value);
        if (bits == 184) return _safeCast.toUint184(value);
        if (bits == 192) return _safeCast.toUint192(value);
        if (bits == 200) return _safeCast.toUint200(value);
        if (bits == 208) return _safeCast.toUint208(value);
        if (bits == 216) return _safeCast.toUint216(value);
        if (bits == 224) return _safeCast.toUint224(value);
        if (bits == 232) return _safeCast.toUint232(value);
        if (bits == 240) return _safeCast.toUint240(value);
        if (bits == 248) return _safeCast.toUint248(value);
        revert("SafeCastTest: unsupported uint bits");
    }

    function _toInt(uint256 bits, int256 value) private view returns (int256) {
        if (bits == 8) return _safeCast.toInt8(value);
        if (bits == 16) return _safeCast.toInt16(value);
        if (bits == 24) return _safeCast.toInt24(value);
        if (bits == 32) return _safeCast.toInt32(value);
        if (bits == 40) return _safeCast.toInt40(value);
        if (bits == 48) return _safeCast.toInt48(value);
        if (bits == 56) return _safeCast.toInt56(value);
        if (bits == 64) return _safeCast.toInt64(value);
        if (bits == 72) return _safeCast.toInt72(value);
        if (bits == 80) return _safeCast.toInt80(value);
        if (bits == 88) return _safeCast.toInt88(value);
        if (bits == 96) return _safeCast.toInt96(value);
        if (bits == 104) return _safeCast.toInt104(value);
        if (bits == 112) return _safeCast.toInt112(value);
        if (bits == 120) return _safeCast.toInt120(value);
        if (bits == 128) return _safeCast.toInt128(value);
        if (bits == 136) return _safeCast.toInt136(value);
        if (bits == 144) return _safeCast.toInt144(value);
        if (bits == 152) return _safeCast.toInt152(value);
        if (bits == 160) return _safeCast.toInt160(value);
        if (bits == 168) return _safeCast.toInt168(value);
        if (bits == 176) return _safeCast.toInt176(value);
        if (bits == 184) return _safeCast.toInt184(value);
        if (bits == 192) return _safeCast.toInt192(value);
        if (bits == 200) return _safeCast.toInt200(value);
        if (bits == 208) return _safeCast.toInt208(value);
        if (bits == 216) return _safeCast.toInt216(value);
        if (bits == 224) return _safeCast.toInt224(value);
        if (bits == 232) return _safeCast.toInt232(value);
        if (bits == 240) return _safeCast.toInt240(value);
        if (bits == 248) return _safeCast.toInt248(value);
        revert("SafeCastTest: unsupported int bits");
    }
}
